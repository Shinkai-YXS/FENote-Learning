<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ajax</title>
</head>

<body>
    <script>
        const xhr = new XMLHttpRequest()
        // 第一个参数表示请求方式(get,post 等)，第二个参数表示请求地址，第三个参数为 true 意思是异步
        xhr.open('GET', './data/test.json', true)
        // 状态变化时会触发 onreadystatechange
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    alert(xhr.responseText)
                }
            }
        }
        // 发送请求
        xhr.send(null)

        ajax({url: './data/test.json'}).then(res => {
            console.log(res)
        })
        /**
         * @Author: YXS
         * @Description: ajax 函数
         */
        function ajax(options) {
            return new Promise((resolve, reject) => {
                let xhr = null, // XMLHttpRequest 对象
                    url = options.url, // URl 地址
                    method = options.method || 'GET', // 传输方式，默认为 get
                    async = typeof (options.async) == "undefined" ? true : options.async,
                    data = options.data || null,
                    params = ''; // 参数字符串
                // 将 data 的对象字面量的形式转换为字符串形式
                if (data) {
                    for (let i in data) {
                        params += i + '=' + data[i] + '&'
                    }
                    // 去掉最后一个 &
                    params = params.replace(/&$/, "")
                }
                // 根据 method 的值改变 url
                if (method.toLocaleUpperCase() === 'GET') {
                    url += '?' + params
                    params = ''
                }
                /**
                 * 创建 XMLHttpRequest 对象
                 */
                if (typeof XMLHttpRequest != 'undefined') {
                    // 判断浏览器是否将 XMLHttpRequest 作为本地对象实现，针对 IE7，Firefox，Opera 等
                    xhr = new XMLHttpRequest()
                } else if (typeof ActiveXObject != 'undefinec') {
                    // 将所有可能出现的 ActiveXObject 版本放在一个数组中
                    const xhrArr = ["Microsoft.XMLHTTP",
                        'MSXML2.XMLHTTP.6.0',
                        'MSXML2.XMLHTTP.5.0',
                        'MSXML2.XMLHTTP.4.0',
                        'MSXML2.XMLHTTP.3.0',
                        'MSXML2.XMLHTTP.2.0']
                    // 遍历创建 XMLHttpRequest 对象
                    const len = xhrArr.length;
                    for (let i = 0; i < len; i++) {
                        try {
                            // 创建 ActiveXObject 对象
                            xhr = new ActiveXObject(xhrArr[i])
                            break;
                        } catch (ex) { }
                    }
                } else {
                    throw new Error('No XHR object availabel.')
                }
                /**
                 * 创建请求
                 */
                xhr.open(method, url, async)
                /**
                 * 设置请求头
                 */
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
                /**
                 * 发送请求
                 */
                console.log(params)
                xhr.send(params)

                xhr.onreadystatechange = function () {
                    console.log(xhr)
                    if (xhr.readyState === 4) {
                        if ((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304) {
                            resolve(JSON.parse(xhr.responseText))
                        } else {
                            reject()
                        }
                    }
                }
            })
        }


        /**
         * @Author: YXS
         * @Description: JSONP
         */
        window.callback = function (data) {
            console.log(data)
        }
    </script>
    <script src="http://localhost:8888/ajax重要知识点/data/jsonp.js"></script>
</body>

</html>