<!--
 * @Author: YXS
 * @Date: 2020-07-02 14:45:22
 * @LastEditors: YXS
 * @LastEditTime: 2020-07-02 17:39:56
 * @Description: 
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" type="text/css" href="style.css">

</head>

<body>
  <div class="register">
    <p class="title" id="title">
      <span>登 录</span>
      <span class="current">注 册</span>
    </p>
    <div class="form">
      <div>
        <span>+86</span>
        <input type="text" name="user" id="user" placeholder="请输入注册手机号" autocomplete="off" data-check="sigup"/>
        <i id="user_icon"></i>
        <p class="info" id="user_info"></p>
      </div>
      <div>
        <input type="password" name="pwd" id="pwd" placeholder="请设置密码">
        <i id="pwd_icon"></i>
        <p class="info" id="pwd_info"></p>
      </div>
      <p class="button">
        <a href="javascript:void(0)" id="sigup-btn" class="btn show">注 册</a>
        <a href="javascript:void(0)" id="login-btn" class="btn">登 录</a>
      </p>
    </div>
  </div>
  <script type="text/javascript" src="ajax.js"></script>
  <script>
    var user = document.getElementById('user'),
        pwd = document.getElementById('pwd'),
        sigup = document.getElementById('sigup-btn'),
        userIcon = document.getElementById('user_icon'),
        userInfo = document.getElementById('user_info'),
        pwdIcon = document.getElementById('pwd_icon'),
        pwdInfo = document.getElementById('pwd_info'),
        userReg = /^1[356789]\d{9}$/,
        pwdReg = /^\w{5,12}$/,
        isRepeat = false,// 记录用户名是否被占用了
        login = document.getElementById('login-btn'),
        titles = document.getElementById('title').getElementsByTagName('span');
    // 检测用户
    function checkUser() {
      var userValue = user.value;
      // 验证手机号是否有效
      if(!userReg.test(userValue)) {
        userInfo.innerHTML = '请输入有效的手机号码'
        userIcon.className = 'no'
      } else {
        userInfo.innerHTML = ''
        userIcon.className = ''
        // 发起请求
        $.ajax({
          url: 'http://localhost:8888/register/server/isUserRepeat.php',
          data: {username: userValue},
          success: function(data) {
            if (data.code == 1) {
              userIcon.className = 'ok'
              isRepeat = false
            } else if(data.code == 0)  {
              isRepeat = true
              userIcon.className = 'no'
              userInfo.innerHTML = data.msg
            } else {
              userInfo.innerHTML = '检测失败，请重试……'
            }
          },
          fail: function(error) {

          }
        })
      }
    }

    // 检测密码
    function checkPwd() {
      var pwdValue = pwd.value;
      if (!pwdReg.test(pwdValue)) {
        pwdInfo.innerHTML = '请输入5到12位的字母、数字及下划线'
        pwdIcon.className = 'no'
      } else {
        pwdInfo.innerHTML = ''
        pwdIcon.className = 'ok'
      }
    }
    // 注册
    function register() {
      var userValue = user.value
      var pwdValue = pwd.value
      // 如果手机号有效且没有被占用，同时密码有效，方可注册
      if (userReg.test(userValue) && pwdReg.test(pwdValue) && !isRepeat) {
        $.ajax({
          url:'http://localhost:8888/register/server/register.php',
          method: "post",
          data: {username: userValue, userpwd: pwdValue},
          success: function(data) {
            // 清空文本框
            user.value = ''
            pwd.value = ''
            showLogin()
          },
          fail: function() {
            pwdInfo.innerHTML = '注册失败，请重试！'
          }
        })
      }
    }
    // 显示登录
    function showLogin() {
      // 载入登录界面，登录高亮显示
      titles[0].className = 'current'
      titles[1].className = ''
      login.className = 'show'
      sigup.className = ''
    }
    // 显示注册
    function showSigup() {
      // 载入登录界面，登录高亮显示
      titles[0].className = ''
      titles[1].className = 'current'
      login.className = ''
      sigup.className = 'show'
    }
    // 绑定事件，检测用户的有效性及是否注册过
    user.addEventListener("blur", checkUser, false)

    // 绑定事件，检测密码的有效性
    pwd.addEventListener('blur', checkPwd, false)

    // 注册
    sigup.addEventListener('click', register, false)

    // 注册登录、切换
    titles[0].addEventListener('click', showLogin, false)
    titles[1].addEventListener('click', showSigup, false)
  </script>
</body>

</html>