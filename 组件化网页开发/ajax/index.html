<!--
 * @Author: YXS
 * @Date: 2020-07-01 14:14:27
 * @LastEditors: YXS
 * @LastEditTime: 2020-07-02 11:45:54
 * @Description:
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="banner" id="banner"></div>
  <div class="banner" id="banner_jq"></div>
  <script type="text/javascript" src="./js/jquery-1.7.1.js"></script>
  <script type="text/javascript">
    var data;
    // 封装通用的xhr对象，兼容各个浏览器版本
    function creatXHR() {
      if (typeof XMLHttpRequest != 'undefined') {
        // 判断浏览器是否将 XMLHttpRequest 作为本地对象实现，针对 IE7，Firefox，Opera 等
        return new XMLHttpRequest()
      } else if (typeof ActiveXObject != 'undefinec') {
        // 将所有可能出现的 ActiveXObject 版本放在一个数组中
        var xhrArr = ["Microsoft.XMLHTTP",
                      'MSXML2.XMLHTTP.6.0',
                      'MSXML2.XMLHTTP.5.0',
                      'MSXML2.XMLHTTP.4.0',
                      'MSXML2.XMLHTTP.3.0',
                      'MSXML2.XMLHTTP.2.0']
        // 遍历创建 XMLHttpRequest 对象
        var len = xhrArr.length, xhr;
        for(var i = 0; i < len; i++) {
          try {
            // 创建 ActiveXObject 对象
            xhr = new ActiveXObject(xhrArr[i])
            break;
          } catch (ex) {}
        }
        return xhr
      } else {
        throw new Error('No XHR object availabel.')
      }
    }
    // XMLHttpRequest 对象
    var xhr = creatXHR()

    // 创建请求
    xhr.open("get", './server/slider.json', true)
    // 设置 http 头部信息
    // xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
    // 响应 XMLHttpRequest 对象状态变化的函数，
    // onreadystatechange 在 readystatechange 属性发生改变事触发
    xhr.onreadystatechange = function() {
      // 异步调用成功
      /**
       * readyState 值：
       * 0：还没有初始化，还没调用 send 方法
       * 1：正在发送请求，已经调用了 send 方法
       * 2：send 方法已经执行完成
       * 3：正在解析响应的内容
       * 4：异步调用成功，响应内容解析完成
       */
      if (xhr.readyState == 4) {
        // 304 表示请求资源没有被修改，可以使用浏览器缓存
        /**
         * status 值：
         * 100：客户端需要继续发出请求
         * 404：资源找不到
        */
        if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
          // 获得服务器返回的数据
          data = JSON.parse(xhr.responseText)
          // 渲染到数据页面中
          renderDataToTom()
        }
      }
    }
    // 发送请求
    xhr.send(null)
    console.log(xhr)
    // 渲染数据
    function renderDataToTom() {
      var img = data.slider, i,
          len = img.length,
          banner = document.getElementById('banner'),
          str = ""
      for(i = 0 ; i < len; i++) {
        console.log(img[i])
        str += '<a href="'+img[i].linkUrl+'"><img src="'+img[i].picUrl+'"></a>'
      }
      banner.innerHTML = str
    }

    // JQuery 的 $.ajax()
    $.ajax({
      url: './server/slider.json', // 请求地址
      tpe: 'post',                 // 请求方式
      async: true,                 // 同步异步
      dataType: 'json',            // 服务端返回的数据格式
      success: function(imgData) {        // 请求成功的回调
        JQrenderDataToTom(imgData.slider)
      }
    })

    function JQrenderDataToTom(imgData) {
      var str = ''
      $.each(imgData, function(index, obj) {
        str += '<a href="'+obj.linkUrl+'"><img src="'+obj.picUrl+'"></a>'
      })
      $("#banner_jq").html(str)
    }

    // 封装 JSONP
    function getJSONP(url, callback) {
      if (!url) return
      // 声明数组用来随机生成函数名
      var a = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j'],
          r1 = Math.floor(Math.random() * a.length),
          r2 = Math.floor(Math.random() * a.length),
          r3 = Math.floor(Math.random() * a.length),
          name = 'getJSONP' + a[r1] + a[r2] + a[r3],
          cbname = 'getJSONP.' + name;
      // 判断 url 地址中是否含有 ? 号
      if(url.indexOf('?')  === -1) {
        url += '?jsonp=' + cbname
      } else {
        url += '&jsonp=' + cbname
      }

      console.log(url)
      // 动态创建 script 标签
      var script = document.createElement('script')
      // 定义被脚本执行的回调函数
      getJSONP[name] = function (data) {
        try {
          callback && callback(data)
        } catch (error) {
          console.log(error)
        } finally {
          // 最后删除该函数及 script 标签
          delete getJSONP[name]
          script.parentNode.removeChild(script)
        }
        console.log(data)
      }
      // 定义 script 的 src
      script.src = url
      document.getElementsByTagName("head")[0].appendChild(script)


    }
    getJSONP('http://class.imooc.com/api/jsonp', function(data) {
      console.log(data)
    })

  </script>
</body>
</html>